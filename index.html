<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Org Chart - Fixed Headcount Version</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@2.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; padding: 20px; color: #1e293b; }
        #controls { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .chart-container { height: 60vh; background: white; border-radius: 12px; border: 1px solid #cbd5e1; }
        .section-title { font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; margin-top: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 10px; }
        label { font-size: 12px; font-weight: 600; color: #475569; display: block; margin-bottom: 5px; }
        input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 13px; }
        .btn { padding: 10px 14px; color: white; border: none; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 12px; transition: transform 0.1s; }
        .btn-blue { background: #2563eb; }
        .btn-red { background: #dc2626; }
        .btn-orange { background: #f59e0b; }
        .btn-purple { background: #7c3aed; }
        .btn-gray { background: #64748b; }
        .btn-green { background: #16a34a; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        .headcount-badge {
            position: absolute; top: -12px; right: -12px; background: #2563eb; color: white;
            border-radius: 50%; min-width: 26px; height: 26px; font-size: 11px; font-weight: 800;
            display: flex; align-items: center; justify-content: center; border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 10;
        }
    </style>
</head>
<body>

<div id="controls">
    <div class="toolbar">
        <h2 style="margin:0">Org Chart Master Editor</h2>
        <div style="display:flex; gap:8px">
            <input type="file" id="fileInput" style="width: auto;" accept=".csv" />
            <button class="btn btn-green" onclick="downloadCSV()">Export CSV</button>
            <button class="btn btn-gray" onclick="chart.exportImg()">Save Image</button>
            <button class="btn btn-gray" style="background:#475569" onclick="resetFilter()">Reset View</button>
        </div>
    </div>

    <div class="section-title">1. Search & Filter</div>
    <div class="grid">
        <div>
            <label>Target Employee</label>
            <input type="text" id="targetEmployee" list="namesList" placeholder="Select existing person...">
        </div>
        <div>
            <label>Department to View</label>
            <input type="text" id="targetDept" list="deptsList" placeholder="Select department...">
        </div>
        <div style="display: flex; align-items: end; gap: 5px;">
            <button class="btn btn-purple" onclick="focusOnTeam()">Focus Team</button>
            <button class="btn btn-purple" style="background:#4338ca" onclick="focusOnDept()">Focus Dept</button>
        </div>
    </div>

    <div class="section-title">2. Modify Existing Employee</div>
    <div class="grid" style="grid-template-columns: 1fr 1fr 2fr;">
        <div>
            <label>New Manager</label>
            <input type="text" id="targetManager" list="namesList" placeholder="Search new boss...">
        </div>
        <div>
            <label>New Department</label>
            <input type="text" id="newDeptInput" list="deptsList" placeholder="New dept name...">
        </div>
        <div style="display: flex; align-items: end; gap: 5px;">
            <button class="btn btn-orange" onclick="actionMove()">Move</button>
            <button class="btn btn-orange" style="background:#f97316" onclick="actionUpdateDept()">Update Dept</button>
            <button class="btn btn-red" onclick="actionDelete()">Delete</button>
        </div>
    </div>

    <div class="section-title">3. Hire New Employee</div>
    <div class="grid">
        <input type="text" id="newName" placeholder="Full Name">
        <input type="text" id="newTitle" placeholder="Job Title">
        <button class="btn btn-blue" onclick="actionAdd()">+ Add to Manager Above</button>
    </div>

    <datalist id="namesList"></datalist>
    <datalist id="deptsList"></datalist>
</div>

<div class="chart-container"></div>

<script>
    let chart = new d3.OrgChart().container('.chart-container');
    let allData = [];

    // --- Fixed Headcount Calculation ---
    function calculateHeadcounts(data) {
        const map = {};
        data.forEach(d => { 
            map[d.id] = d; 
            d._totalHeadcount = 0; 
        });

        data.forEach(d => {
            let parent = map[d.parentId];
            while (parent) {
                parent._totalHeadcount++;
                parent = map[parent.parentId];
            }
        });
    }

    function actionUpdateDept() {
        const empName = document.getElementById('targetEmployee').value;
        const deptName = document.getElementById('newDeptInput').value;
        const employee = allData.find(d => d.id === empName);
        if (employee) {
            employee.department = deptName;
            refresh();
        }
    }

    function focusOnDept() {
        const dept = document.getElementById('targetDept').value;
        if (!dept) return;
        const deptData = allData.filter(d => d.department === dept || d.isGhost);
        const processedData = JSON.parse(JSON.stringify(deptData));
        calculateHeadcounts(processedData);
        chart.data(processedData).render().fit();
    }

    function focusOnTeam() {
        const name = document.getElementById('targetEmployee').value;
        const rootNode = allData.find(d => d.id === name);
        if (!rootNode) return;
        const descendants = [rootNode];
        function getChildren(parentId) {
            allData.forEach(d => { if (d.parentId === parentId) { descendants.push(d); getChildren(d.id); } });
        }
        getChildren(name);
        const focusedData = JSON.parse(JSON.stringify(descendants));
        calculateHeadcounts(focusedData);
        focusedData.find(d => d.id === name).parentId = null;
        chart.data(focusedData).render().fit();
    }

    function actionMove() {
        const empName = document.getElementById('targetEmployee').value;
        const managerName = document.getElementById('targetManager').value;
        const employee = allData.find(d => d.id === empName);
        if (employee && managerName) { employee.parentId = managerName; refresh(); }
    }

    function actionDelete() {
        const name = document.getElementById('targetEmployee').value;
        const person = allData.find(d => d.id === name);
        if (person && confirm(`Delete ${name}?`)) {
            allData.forEach(d => { if (d.parentId === name) d.parentId = person.parentId; });
            allData = allData.filter(d => d.id !== name);
            refresh();
        }
    }

    function actionAdd() {
        const name = document.getElementById('newName').value;
        const manager = document.getElementById('targetManager').value;
        const dept = document.getElementById('newDeptInput').value;
        if (name && manager) {
            allData.push({ id: name, name: name, parentId: manager, title: document.getElementById('newTitle').value, department: dept });
            refresh();
        }
    }

    function resetFilter() { refresh(); }

    function refresh() {
        calculateHeadcounts(allData);
        updateAutocomplete();
        chart.data(allData).render().fit();
    }

    function updateAutocomplete() {
        const nList = document.getElementById('namesList');
        const dList = document.getElementById('deptsList');
        const depts = new Set();
        nList.innerHTML = ""; dList.innerHTML = "";
        allData.filter(d => !d.isGhost).forEach(d => {
            const optN = document.createElement('option'); optN.value = d.name; nList.appendChild(optN);
            if (d.department) depts.add(d.department);
        });
        depts.forEach(dept => {
            const optD = document.createElement('option'); optD.value = dept; dList.appendChild(optD);
        });
    }

    function parseCSV(text) {
        const rows = []; let cur = []; let field = ''; let inQ = false;
        for (let i = 0; i < text.length; i++) {
            let c = text[i];
            if (c === '"' && inQ && text[i+1] === '"') { field += '"'; i++; }
            else if (c === '"') inQ = !inQ;
            else if (c === ',' && !inQ) { cur.push(field.trim()); field = ''; }
            else if ((c === '\n' || c === '\r') && !inQ) {
                if (field || cur.length > 0) { cur.push(field.trim()); rows.push(cur); }
                cur = []; field = ''; if (c === '\r' && text[i+1] === '\n') i++;
            } else field += c;
        }
        if (field || cur.length > 0) { cur.push(field.trim()); rows.push(cur); }
        return rows;
    }

    function downloadCSV() {
        let csv = "Name,Title,Manager,Department\n";
        allData.filter(d => !d.isGhost).forEach(d => {
            csv += `"${d.name}","${d.title}","${d.parentId === 'ROOT' ? '' : d.parentId}","${d.department}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'updated_org.csv'; a.click();
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const rows = parseCSV(event.target.result);
            allData = rows.slice(1).map(cols => ({
                id: cols[0], name: cols[0], title: cols[1] || "",
                parentId: cols[2] || "ROOT", department: cols[3] || ""
            }));
            const names = new Set(allData.map(d => d.id));
            allData.forEach(d => { if (d.parentId !== "ROOT" && !names.has(d.parentId)) d.parentId = "ROOT"; });
            allData.push({ id: "ROOT", name: "Company", isGhost: true });
            
            chart.nodeWidth(d => 220).nodeHeight(d => 100).compact(true)
                .nodeContent(d => {
                    if (d.data.isGhost) return `<div style="display:none"></div>`;
                    const badge = d.data._totalHeadcount > 0 ? `<div class="headcount-badge">${d.data._totalHeadcount}</div>` : '';
                    return `
                    <div style="position:relative; padding:12px; background:white; border:1px solid #cbd5e1; border-radius:10px; height:76px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        ${badge}
                        <div style="font-weight:700; font-size:13px; color:#1e293b; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${d.data.name}</div>
                        <div style="font-size:11px; color:#64748b; margin-top:2px;">${d.data.title}</div>
                        <div style="display:inline-block; font-size:10px; color:#2563eb; background:#eff6ff; padding:2px 6px; border-radius:4px; margin-top:6px; font-weight:bold;">${d.data.department}</div>
                    </div>`;
                });
            refresh();
        };
        reader.readAsText(e.target.files[0]);
    });
</script>
</body>
</html>
